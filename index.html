<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</title>
  <style>
    body {
      font-family: Arial;
      background: #f0f2f5;
      text-align: center;
      padding: 50px;
    }
    .hidden {
      display: none;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      width: 400px;
      margin: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 16px;
    }
    canvas {
      margin-top: 20px;
      border: 1px solid #ccc;
      max-width: 100%;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø®Ø¯Ù…Ø©</h2>
  <div id="subscriptionForm">
    <input type="text" id="name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" required>
    <input type="email" id="email" placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
    <button id="subscribeBtn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button>
  </div>
  <p id="statusText"></p>
</div>

<canvas id="certificateCanvas" class="hidden" width="800" height="600"></canvas>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAJzK9G2MJieXHmeeHUBdULdDt8NwyxyKQ",
    authDomain: "khedma-fd534.firebaseapp.com",
    databaseURL: "https://khedma-fd534-default-rtdb.firebaseio.com",
    projectId: "khedma-fd534",
    storageBucket: "khedma-fd534.appspot.com",
    messagingSenderId: "186556101962",
    appId: "1:186556101962:web:de1945009a23d99cf83db3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const nameInput = document.getElementById("name");
  const emailInput = document.getElementById("email");
  const subscribeBtn = document.getElementById("subscribeBtn");
  const statusText = document.getElementById("statusText");

  const TELEGRAM_BOT_TOKEN = "7332970120:AAGitBB77oX2MuvEJg16anXOCUMEqA2lJ1E";
  const TELEGRAM_CHAT_ID = "6923044013";

  subscribeBtn.addEventListener("click", async () => {
    const name = nameInput.value.trim();
    const email = emailInput.value.trim();
    if (!name || !email) {
      alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ");
      return;
    }

    const userId = email.replace(/[@.]/g, "_");

    await set(ref(db, "subscribers/" + userId), { name, email });

    const snapshot = await get(child(ref(db), "subscribers"));
    const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
    const today = new Date().toLocaleDateString("ar-EG");

    sendTelegramMessage("âœ… ØªÙ…Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©", name, email, count);
    generateCertificate(name, today, count);

    statusText.textContent = "ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­!";
  });

  function sendTelegramMessage(status, name, email, count) {
    const message = `${status}\nðŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}\nðŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯: ${email}\nØ¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†: ${count}`;
    fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        chat_id: TELEGRAM_CHAT_ID,
        text: message
      })
    });
  }

  function generateCertificate(name, date, count) {
    const canvas = document.getElementById("certificateCanvas");
    const ctx = canvas.getContext("2d");
    const img = new Image();
    img.src = "Ù¢Ù Ù¢Ù¥Ù Ù¤Ù¡Ù©_Ù¡Ù¨Ù¢Ù¢Ù¡Ù£.jpg"; // Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† ÙÙŠ Ù†ÙØ³ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØµÙØ­Ø©

    img.onload = () => {
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#000";
      ctx.font = "bold 28px Arial";
      ctx.textAlign = "center";
      ctx.fillText(`Ø§Ù„Ø§Ø³Ù…: ${name}`, canvas.width / 2, 350);
      ctx.fillText(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}`, canvas.width / 2, 400);
      ctx.fillText(`Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†: ${count}`, canvas.width / 2, 450);

      canvas.classList.remove("hidden");

      const link = document.createElement("a");
      link.download = "Ø´Ù‡Ø§Ø¯Ø©-Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    };
  }
</script>

</body>
</html>
