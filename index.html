<!DOCTYPE html>
<html lang="ar">
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400;1,700&family=Cairo:wght@200..1000&family=Lateef:wght@200;300;400;500;600;700;800&family=Reem+Kufi:wght@400..700&family=Ruwudu:wght@400;500;600;700&family=Scheherazade+New:wght@400;500;600;700&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø®Ø¯Ù…Ø©</title>
  <!-- Ø¥Ø¶Ø§ÙØ© Web Font Loader -->
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙØ­Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ */
    html {
      visibility: hidden;
      background: #fff; /* Ø´Ø§Ø´Ø© Ø¨ÙŠØ¶Ø§Ø¡ */
    }
    /* Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·ÙˆØ· */
    html.fonts-loaded {
      visibility: visible;
    }
    body {
      font-family: "Scheherazade New", serif;
      background: #f7f9fc;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      background: #ffffff;
      padding: 30px 40px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      text-align: center;
      width: 400px;
    }
    .container h1 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #333;
    }
    input {
      width: 100%;
      padding: 12px 15px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      outline: none;
      transition: all 0.3s ease;
    }
    input:focus {
      border-color: #3498db;
      box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
    }
    button {
      padding: 12px 20px;
      font-size: 16px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin: 10px 0;
      width: 100%;
    }
    button:hover {
      background-color: #2980b9;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .hidden {
      display: none;
    }
    #status {
      font-size: 18px;
      color: #27ae60;
      margin-top: 20px;
    }
    #subscriberCount {
      font-weight: bold;
      color: #3498db;
    }
    #certificatePreview {
      margin-top: 20px;
      max-width: 100%;
      border: 2px solid #3498db;
      border-radius: 5px;
    }
    #loading {
      display: none;
      color: red;
    }
    #ok{
      color: green;
    }
    #loadingimg {
      height: 100px;
      width: 100px;
      display: none;
      
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø®Ø¯Ù…Ø©</h1>
    <div id="subscriptionForm" class="hidden">
      <input type="text" id="name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" required>
      <input type="email" id="email" placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
      <button id="confirmSubscribeBtn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button>
    </div>
    <button id="toggleSubscribeBtn">ØªØ§Ø¨Ø¹ Ø§Ù„Ø®Ø¯Ù…Ø©</button>
    <p id="status">Ù„Ù… ØªØªØ§Ø¨Ø¹</p>
    <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†: <span id="subscriberCount">0</span></p>
    <p id="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</p>
    <center>
    <img id="loadingimg" src="Loading_2.gif">
    </center>
    <img id="certificatePreview" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©" class="hidden">
  </div>

  <script type="module">
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·ÙˆØ· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Font Loader
    WebFont.load({
      google: {
        families: [
          'Amiri:400,700,400italic,700italic',
          'Cairo:200,300,400,500,600,700,800,900,1000',
          'Lateef:200,300,400,500,600,700,800',
          'Reem Kufi:400,500,600,700',
          'Ruwudu:400,500,600,700',
          'Scheherazade New:400,500,600,700'
        ]
      },
      loading: function() {
        document.documentElement.classList.add('fonts-loading'); // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø®ÙØ§Ø¡
      },
      active: function() {
        document.documentElement.classList.remove('fonts-loading');
        document.documentElement.classList.add('fonts-loaded'); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø©
      },
      inactive: function() {
        document.documentElement.classList.remove('fonts-loading');
        document.documentElement.classList.add('fonts-loaded'); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„
      }
    });

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, remove, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    const loading = document.getElementById('loading');
    const loadingimg = document.getElementById('loadingimg');
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAJzK9G2MJieXHmeeHUBdULdNwyxyKQ",
      authDomain: "khedma-fd534.firebaseapp.com",
      databaseURL: "https://khedma-fd534-default-rtdb.firebaseio.com",
      projectId: "khedma-fd534",
      storageBucket: "khedma-fd534.firebasestorage.app",
      messagingSenderId: "186556101962",
      appId: "1:186556101962:web:de1945009a23d99cf83db3",
      measurementId: "G-JNTZRQ2W4S"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const toggleSubscribeBtn = document.getElementById("toggleSubscribeBtn");
    const confirmSubscribeBtn = document.getElementById("confirmSubscribeBtn");
    const statusText = document.getElementById("status");
    const subscriberCount = document.getElementById("subscriberCount");
    const nameInput = document.getElementById("name");
    const emailInput = document.getElementById("email");
    const subscriptionForm = document.getElementById("subscriptionForm");
    const certificatePreview = document.getElementById("certificatePreview");

    const TELEGRAM_BOT_TOKEN = "7332970120:AAGitBB77oX2MuvEJg16anXOCUMEqA2lJ1E";
    const TELEGRAM_CHAT_ID = "6923044013";

    const imageURL = "https://raw.githubusercontent.com/midoandbodyemish/certificate/refs/heads/main/Ù¢Ù Ù¢Ù¥Ù Ù¤Ù¡Ù©_Ù¡Ù¨Ù¢Ù¢Ù¡Ù£.jpg";

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
    function updateSubscriberCount() {
      get(child(ref(db), "subscribers")).then((snapshot) => {
        let count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
        subscriberCount.textContent = count;
      }).catch(error => {
        console.error("Error fetching subscriber count:", error);
      });
    }

    // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Telegram
    function sendTelegramMessage(action, name, email) {
      get(child(ref(db), "subscribers")).then((snapshot) => {
        let count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
        let message = action === "subscribe"
          ? `âœ… ØªÙ…Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­!\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}\nğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯: ${email}\nØ¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†: ${count}`
          : `âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©!\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}\nğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯: ${email}\nØ¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†: ${count}`;

        fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            text: message,
            parse_mode: "HTML"
          })
        }).then(response => response.json())
        .then(data => {
          console.log(data.ok ? "Telegram message sent." : "Error sending Telegram message:", data);
        }).catch(error => {
          console.error("Error sending Telegram message:", error);
        });
      });
    }

    // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
    function generateCertificate(name, subscriberCount) {
      console.log("Starting certificate generation for:", name, subscriberCount);

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§
      const img = new Image();
      img.crossOrigin = "Anonymous";
      img.src = imageURL + "?t=" + new Date().getTime();

      img.onload = () => {
        console.log("Background image loaded.");

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø· Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø³Ù…
        document.fonts.load('32px "Scheherazade New"').then(() => {
          // Ø¥Ù†Ø´Ø§Ø¡ canvas
          const canvas = document.createElement("canvas");
          canvas.width = 600;
          canvas.height = 400;
          const ctx = canvas.getContext("2d");

          // Ø±Ø³Ù… ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©
          ctx.drawImage(img, 0, 0, 600, 400);

          // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø· Ù„Ù„Ø§Ø³Ù…
          ctx.font = '32px "Scheherazade New", serif';
          ctx.fillStyle = "blue";
          ctx.textAlign = "right";
          ctx.fillText(`${name}`, 563, 202);

          // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø· Ù„Ù„ØªØ§Ø±ÙŠØ® ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
          ctx.font = "30px Arial";
          ctx.textAlign = "center";
          ctx.fillStyle = "red";
          ctx.fillText(`${new Date().toLocaleDateString('ar-EG')}`, 190, 385);
          ctx.fillText(`${subscriberCount}`, 390, 299);

          // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø©
          try {
            const certificateDataURL = canvas.toDataURL("image/png");
            certificatePreview.src = certificateDataURL;
            certificatePreview.classList.remove("hidden");
            loading.innerHTML = '<p id="ok">ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</p>';
            loadingimg.style.display = 'none';
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
            const link = document.createElement("a");
            link.download = `certificate_${name}.png`;
            link.href = certificateDataURL;
            link.click();
            console.log("Certificate downloaded.");
          } catch (error) {
            console.error("Error displaying or downloading certificate:", error);
            alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: " + error.message);
          }
        }).catch(error => {
          console.error("Error loading font:", error);
          alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø· Scheherazade New. Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        });
      };

      img.onerror = () => {
        console.error("Failed to load image:", imageURL);
        alert("Ø®Ø·Ø£: ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©. Ø¬Ø±Ø¨ Ø§Ø³ØªØ¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Firebase Storage.");
      };
    }

    // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "ØªØ§Ø¨Ø¹ Ø§Ù„Ø®Ø¯Ù…Ø©" Ø£Ùˆ "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©"
    toggleSubscribeBtn.addEventListener("click", () => {
      const savedData = localStorage.getItem("subscribed");

      if (savedData) {
        const userData = JSON.parse(savedData);
        const userId = userData.email.replace(/[@.]/g, "_");

        remove(ref(db, "subscribers/" + userId)).then(() => {
          statusText.textContent = "ØªÙ… Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©";
          localStorage.removeItem("subscribed");
          toggleSubscribeBtn.textContent = "ØªØ§Ø¨Ø¹ Ø§Ù„Ø®Ø¯Ù…Ø©";
          updateSubscriberCount();
          sendTelegramMessage("unsubscribe", userData.name, userData.email);
          certificatePreview.classList.add("hidden");
        }).catch(error => {
          console.error("Error unsubscribing:", error);
        });
      } else {
        subscriptionForm.classList.remove("hidden");
        toggleSubscribeBtn.classList.add("hidden");
      }
    });

    // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ"
    confirmSubscribeBtn.addEventListener("click", () => {
      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      if (!name || !email) return alert("ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ!");

      const userId = email.replace(/[@.]/g, "_");

      set(ref(db, "subscribers/" + userId), { name, email }).then(() => {
        statusText.textContent = "ØªÙ…Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©";
        localStorage.setItem("subscribed", JSON.stringify({ name, email }));
        toggleSubscribeBtn.textContent = "Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©";
        subscriptionForm.classList.add("hidden");
        toggleSubscribeBtn.classList.remove("hidden");

        get(child(ref(db), "subscribers")).then((snapshot) => {
          let count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
          subscriberCount.textContent = count;
          sendTelegramMessage("subscribe", name, email);
          generateCertificate(name, count);
        }).catch(error => {
          console.error("Error fetching subscriber count:", error);
          alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†.");
        });
      }).catch(error => {
        console.error("Error subscribing:", error);
        alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ.");
      });

      loading.style.display = 'block';
      loadingimg.style.display = 'block';
    });

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚
    const savedData = localStorage.getItem("subscribed");
    if (savedData) {
      statusText.textContent = "ØªÙ…Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø§Ù„ÙØ¹Ù„";
      toggleSubscribeBtn.textContent = "Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©";
    }

    updateSubscriberCount();
  </script>
</body>
</html>
